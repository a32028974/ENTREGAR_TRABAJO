<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Entrega â€¢ Ã“ptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  :root { --bg:#0b1220; --card:#121a2b; --text:#e8eefc; --muted:#9fb0d6; --accent:#7cc0ff; }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
  .wrap{max-width:520px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid #1e2a42;border-radius:14px;padding:16px;box-shadow:0 6px 22px rgba(0,0,0,.25)}
  h1{margin:0 0 12px 0;font-size:20px}
  label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px}
  input,select,button{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #2a3b5f;background:#0e1626;color:var(--text)}
  input::placeholder{color:#6e82ad}
  button{background:var(--accent); color:#05223a; font-weight:700; border:none; cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .ok{color:#8fffb3;margin-top:8px}
  .err{color:#ff9c9c;margin-top:8px}
  .muted{color:var(--muted)}
  .hidden{display:none}
  .pill{display:inline-block;background:#0f223a;border:1px solid #294a78;color:#b8d5ff;border-radius:999px;padding:6px 10px;margin-top:6px}
  .hr{height:1px;background:#203152;margin:14px 0}

  .table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px;
           background:#0e1626; border:1px solid #2a3b5f; border-radius: 10px; overflow: hidden; }
  .table th, .table td { padding: 8px 10px; border-bottom: 1px solid #22324f; text-align: left; white-space: nowrap; }
  .table tr:last-child td { border-bottom: 0; }
  .table th { color:#b8d5ff; font-weight:600; background:#0f1a2c; }
  .table tr { cursor: pointer; }
  .table tr:hover { background:#0f223a; }
  .table .num { font-weight:700; color:#9fd1ff; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px;
           border:1px solid #294a78; color:#b8d5ff; background:#0f223a; }

  .spinner { display:inline-block; width:14px; height:14px; border:2px solid #6e82ad; border-top-color:transparent; border-radius:50%; vertical-align:-2px; animation:spin 1s linear infinite; margin-right:6px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .table tr:focus { outline:2px solid #7cc0ff; outline-offset:-2px; }

  /* Scanner */
  .input-row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
  .scanBtn { padding:12px 14px; border-radius:10px; border:1px solid #2a3b5f; background:#113052; color:#b8d5ff; font-weight:700; }
  .scanBtn:hover { background:#14365d; }

  .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 9999; }
  .modal.show { display:flex; }
  .modal-card { width: min(520px, 96vw); background: var(--card); border:1px solid #1e2a42; border-radius: 14px; padding: 12px; box-shadow: 0 12px 32px rgba(0,0,0,.45); }
  .modal-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .modal-title { font-weight:700; font-size:16px; }
  .modal-actions { display:flex; gap:8px; }
  .btn { padding:10px 12px; border-radius:10px; border:1px solid #2a3b5f; background:#0e1626; color:var(--text); cursor:pointer; }
  .btn.primary { background: var(--accent); color:#05223a; border:none; font-weight:700; }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }

  .videoWrap { position: relative; margin-top:10px; border-radius:12px; overflow:hidden; border:1px solid #22324f; background:#000; }
  video { width:100%; height:auto; display:block; }
  .reticle { position:absolute; inset:10%; border:2px dashed rgba(255,255,255,.35); border-radius:12px; pointer-events:none; }
  .torchHint { margin-top:8px; font-size:12px; color:#9fb0d6; }
  .supportWarn { margin-top:8px; font-size:13px; color:#ffcc99; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Registrar entrega / pago</h1>

      <label for="numero">NÃºmero de trabajo</label>
      <div class="input-row">
        <input id="numero" type="text" inputmode="numeric" placeholder="EscribÃ­ el nÃºmero y presionÃ¡ Enter" autocomplete="off" />
        <button id="scanBtn" class="scanBtn" type="button">ðŸ“· Escanear</button>
      </div>
      <div id="status" class="muted" aria-live="polite"></div>

      <div id="listaWrap" class="hidden">
        <div class="hr"></div>
        <div class="muted">Coincidencias encontradas (elegÃ­ una)</div>
        <div class="tableWrap" style="overflow:auto; max-height:260px; border-radius:10px; margin-top:6px;">
          <table class="table" id="lista"></table>
        </div>
      </div>

      <div id="resultado" class="hidden">
        <div class="hr"></div>
        <div class="muted">Paciente</div>
        <div id="paciente" class="pill"></div>

        <div class="hr"></div>

        <label for="entregadoPor">Â¿QuiÃ©n entregÃ³?</label>
        <input id="entregadoPor" type="text" placeholder="Nombre del vendedor/a que entregÃ³" autocomplete="off" />

        <div class="row">
          <div>
            <label for="cancelo">Â¿CuÃ¡nto pagÃ³?</label>
            <input id="cancelo" type="number" step="0.01" placeholder="0.00" inputmode="decimal" />
          </div>
          <div>
            <label for="fdm">Â¿CÃ³mo pagÃ³?</label>
            <select id="fdm">
              <option value="">ElegÃ­ una opciÃ³nâ€¦</option>
              <option>EFECTIVO</option>
              <option>TARJETA 1P</option>
              <option>TARJETA 3P</option>
              <option>TARJETA 6P</option>
              <option>TARJETA 12P</option>
              <option>TRANSFERENCIA</option>
              <option>MERCADO PAGO</option>
              <option>OTRO</option>
            </select>
          </div>
        </div>

        <div id="wrapFdmOtro" class="hidden">
          <label for="fdmOtro">EspecificÃ¡ el medio de pago</label>
          <input id="fdmOtro" type="text" placeholder="Ej: CHEQUE, VALE, PROMO X, etc." autocomplete="off" />
        </div>

        <div class="hr"></div>
        <button id="guardarBtn" disabled>Guardar</button>
        <div id="saveMsg" class="ok hidden">âœ” Guardado</div>
        <div id="saveErr" class="err hidden"></div>
      </div>
    </div>
  </div>

  <!-- MODAL SCANNER -->
  <div id="scannerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="scanTitle">
    <div class="modal-card">
      <div class="modal-header">
        <div id="scanTitle" class="modal-title">Escanear cÃ³digo de barras</div>
        <div class="modal-actions">
          <button id="torchBtn" class="btn" type="button" disabled>Linterna</button>
          <button id="closeScan" class="btn" type="button">Cancelar</button>
        </div>
      </div>
      <div id="supportWarn" class="supportWarn hidden">Tu navegador no soporta lector nativo. ProbÃ¡ con Chrome en Android o seguimos con el lector alternativo.</div>
      <div class="videoWrap">
        <video id="video" autoplay playsinline muted></video>
        <div class="reticle"></div>
      </div>
      <div class="torchHint">AcomodÃ¡ el cÃ³digo dentro del marco. Se detecta y completa solo.</div>
      <div id="scanStatus" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- ZXing (fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<script>
  // === TU URL DE APP SCRIPT ===
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx2oao4ZVckDweyVZJ1u9rlH72xS4d8UEIR72qxG5fQOuSM4ooLWL9a17lTVD93AzloaQ/exec';

  const $ = (id)=>document.getElementById(id);
  const numeroInput = $('numero');
  const status = $('status');
  const listaWrap = $('listaWrap');
  const listaTable = $('lista');
  const resultado = $('resultado');
  const paciente = $('paciente');
  const entregadoPor = $('entregadoPor');
  const cancelo = $('cancelo');
  const fdm = $('fdm');
  const fdmOtroWrap = $('wrapFdmOtro');
  const fdmOtro = $('fdmOtro');
  const guardarBtn = $('guardarBtn');
  const saveMsg = $('saveMsg');
  const saveErr = $('saveErr');

  // Scanner
  const scanBtn = $('scanBtn');
  const modal = $('scannerModal');
  const video = $('video');
  const closeScan = $('closeScan');
  const torchBtn = $('torchBtn');
  const supportWarn = $('supportWarn');
  const scanStatus = $('scanStatus');

  let currentNumero = null;

  function withParams(base, params){
    const u = new URL(base);
    Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
    return u.toString();
  }
  const normStr = (v)=> (v==null ? '' : String(v)).trim();
  function setStatusLoading(msg='Buscandoâ€¦'){ status.innerHTML = '<span class="spinner"></span>'+msg; }
  function clearStatus(){ status.textContent = ''; }

  // ============ Render mÃºltiple ============
  function renderLista(items){
    listaTable.innerHTML = '';
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th>NÂ°</th><th>Paciente</th><th>DNI</th><th>Tel.</th><th>Estado</th><th>Retira</th>
      </tr>`;
    const tbody = document.createElement('tbody');

    items.forEach(it=>{
      const tr = document.createElement('tr'); tr.tabIndex = 0;
      tr.innerHTML = `
        <td class="num">${normStr(it.numero || it.nro || it.num)}</td>
        <td>${normStr(it.nombre || it.paciente)}</td>
        <td>${normStr(it.dni)}</td>
        <td>${normStr(it.telefono || it.tel)}</td>
        <td>${normStr(it.estado) ? `<span class="badge">${it.estado}</span>`:''}</td>
        <td>${normStr(it.retira || it.fechaRetira || it.retiro)}</td>`;
      tr.addEventListener('click', ()=> chooseItem(it));
      tr.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') chooseItem(it); });
      tbody.appendChild(tr);
    });

    listaTable.appendChild(thead);
    listaTable.appendChild(tbody);
    listaWrap.classList.remove('hidden');
  }
  function hideLista(){ listaWrap.classList.add('hidden'); listaTable.innerHTML = ''; }
  function chooseItem(item){
    const numero = item.numero || item.nro || item.num;
    currentNumero = numero;
    paciente.textContent = normStr(item.nombre || item.paciente) || '(sin nombre)';
    status.textContent  = `Elegido NÂ° ${numero}`;
    hideLista(); resultado.classList.remove('hidden'); guardarBtn.disabled = false; entregadoPor.focus();
  }

  // ============ Lookup ============
  async function lookup(numero){
    setStatusLoading();
    hideLista(); resultado.classList.add('hidden'); saveMsg.classList.add('hidden'); saveErr.classList.add('hidden');
    guardarBtn.disabled = true; currentNumero = null;

    try{
      const url = withParams(SCRIPT_URL, { action:'lookup', numero });
      const res = await fetch(url, { method:'GET' });
      if (!res.ok) throw new Error('Error de red');
      const data = await res.json();

      if (Array.isArray(data)) {
        if (data.length === 0) throw new Error('No encontrado');
        if (data.length === 1) chooseItem(data[0]); else { status.textContent = `Se encontraron ${data.length} coincidencias`; renderLista(data); }
        return;
      }
      if (data.ok === false) { clearStatus(); throw new Error(data.error || 'No encontrado'); }

      const list = data.items || data.results;
      if (Array.isArray(list)) {
        if (list.length === 0) throw new Error('No encontrado');
        if (list.length === 1) chooseItem(list[0]); else { status.textContent = `Se encontraron ${list.length} coincidencias`; renderLista(list); }
      } else {
        currentNumero = numero;
        paciente.textContent = normStr(data.nombre || data.paciente) || '(sin nombre)';
        status.textContent = `Encontrado NÂ° ${numero}`;
        resultado.classList.remove('hidden'); guardarBtn.disabled = false; entregadoPor.focus();
      }
    }catch(e){
      clearStatus(); resultado.classList.add('hidden'); hideLista(); alert(e.message || 'Error buscando');
    }
  }

  // ============ Guardar ============
  async function save(){
    saveMsg.classList.add('hidden'); saveErr.classList.add('hidden');
    const ep  = (entregadoPor.value||'').trim();
    const aj  = (cancelo.value||'').trim();
    const ak  = (fdm.value||'').trim();
    const akOtro = (fdmOtro.value||'').trim();

    if (!currentNumero){ saveErr.textContent='Primero buscÃ¡ y elegÃ­ un nÃºmero vÃ¡lido.'; saveErr.classList.remove('hidden'); return; }
    if (!ep){ saveErr.textContent='CompletÃ¡ "QuiÃ©n entregÃ³".'; saveErr.classList.remove('hidden'); entregadoPor.focus(); return; }
    if (!ak){ saveErr.textContent='ElegÃ­ el medio de pago.'; saveErr.classList.remove('hidden'); fdm.focus(); return; }
    if (ak==='OTRO' && !akOtro){ saveErr.textContent='EspecificÃ¡ el medio de pago en "OTRO".'; saveErr.classList.remove('hidden'); fdmOtro.focus(); return; }

    guardarBtn.disabled = true; const oldTxt = guardarBtn.textContent; guardarBtn.textContent = 'Guardandoâ€¦';
    try{
      const url = withParams(SCRIPT_URL, { action:'save', numero: currentNumero, entregadoPor: ep, cancelo: aj, fdm: ak, fdmOtro: akOtro });
      const res = await fetch(url, { method:'GET' });
      if (!res.ok) throw new Error('Error de red');
      const data = await res.json();
      if (data.ok === false) throw new Error(data.error || 'No se pudo guardar');
      saveErr.classList.add('hidden'); saveMsg.classList.remove('hidden');
    }catch(e){
      saveErr.textContent = e.message || 'Error guardando'; saveErr.classList.remove('hidden');
    }finally{
      guardarBtn.textContent = oldTxt; guardarBtn.disabled = false;
    }
  }

  numeroInput.addEventListener('keydown', (ev)=>{
    if (ev.key === 'Enter'){
      const val = (numeroInput.value||'').trim();
      if (val) lookup(val);
    }
  });
  $('guardarBtn').addEventListener('click', save);

  // ============ Scanner con fallback ============
  let stream = null, videoTrack = null, torchOn = false;
  let usingZXing = false, zxingReader = null, zxingActive = false;
  let detector = null, detectorReady = false;

  async function startScanner(){
    modal.classList.add('show');
    torchBtn.disabled = true; torchOn = false; usingZXing = false; zxingActive = false;

    // Abrir cÃ¡mara
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      videoTrack = stream.getVideoTracks()[0];

      // Torch support
      const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
      torchBtn.disabled = !(caps && 'torch' in caps);

      // Intento con BarcodeDetector
      detectorReady = false;
      if ('BarcodeDetector' in window) {
        try{
          detector = new window.BarcodeDetector({
            formats: ['ean-13','ean-8','code-128','code-39','upc-a','upc-e','itf','codabar','qr_code']
          });
          detectorReady = true;
        }catch(_){}
      } else {
        supportWarn.classList.remove('hidden');
      }

      scanStatus.textContent = detectorReady ? 'ApuntÃ¡ al cÃ³digoâ€¦' : 'Iniciando lector alternativoâ€¦';

      // Si no hay detector, o si no detecta nada en 1500ms, arrancamos ZXing
      if (!detectorReady) {
        startZXing();
      } else {
        const timer = setTimeout(()=>{ if (!usingZXing) startZXing(); }, 1500);
        scanLoop(timer);
      }
    }catch(err){
      scanStatus.textContent = 'No se pudo abrir la cÃ¡mara. RevisÃ¡ permisos.';
    }
  }

  function stopScanner(){
    if (zxingActive && zxingReader){ zxingReader.reset(); zxingActive = false; }
    if (videoTrack){ videoTrack.stop(); videoTrack = null; }
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    detector = null; detectorReady = false; usingZXing = false; torchOn = false; torchBtn.disabled = true;
    video.srcObject = null; scanStatus.textContent = '';
  }

  async function scanLoop(timer){
    try{
      if (!detectorReady || usingZXing) return;
      const codes = await detector.detect(video);
      if (codes && codes.length){
        clearTimeout(timer);
        const value = String(codes[0].rawValue || '').trim();
        if (value) return onCodeDetected(value);
      }
    }catch(_){}
    requestAnimationFrame(()=>scanLoop(timer));
  }

  function startZXing(){
    usingZXing = true;
    supportWarn.classList.add('hidden'); // ya estamos manejando fallback
    try{
      zxingReader = new ZXing.BrowserMultiFormatReader();
      zxingReader.decodeFromVideoDevice(null, video, (result, err) => {
        zxingActive = true;
        if (result && result.text){
          onCodeDetected(String(result.text).trim());
        }
      });
      scanStatus.textContent = 'Lector alternativo activoâ€¦';
    }catch(e){
      scanStatus.textContent = 'No se pudo iniciar el lector alternativo.';
    }
  }

  function onCodeDetected(value){
    modal.classList.remove('show');
    const soloDigitos = value.replace(/[^\d]/g,'');
    numeroInput.value = soloDigitos || value;
    stopScanner();
    if (numeroInput.value.trim()) lookup(numeroInput.value.trim());
  }

  async function toggleTorch(){
    if (!videoTrack) return;
    try{
      await videoTrack.applyConstraints({ advanced: [{ torch: !torchOn }] });
      torchOn = !torchOn;
      torchBtn.textContent = torchOn ? 'Linterna (ON)' : 'Linterna';
    }catch(_){}
  }

  // Eventos modal
  scanBtn.addEventListener('click', startScanner);
  closeScan.addEventListener('click', ()=>{ modal.classList.remove('show'); stopScanner(); });
  torchBtn.addEventListener('click', toggleTorch);
  modal.addEventListener('click', (e)=>{ if (e.target === modal){ modal.classList.remove('show'); stopScanner(); }});
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modal.classList.contains('show')){ modal.classList.remove('show'); stopScanner(); }});
</script>
</body>
</html>